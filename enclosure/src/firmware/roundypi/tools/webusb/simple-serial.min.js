!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).SimpleSerial={})}(this,(function(e){"use strict";function t(e){if("number"==typeof e)return e;if("string"!=typeof e||isNaN(e)||isNaN(parseFloat(e))){if(Array.isArray(e)){let n=[];return e.forEach((e=>{n.push(t(e))})),n}if("object"==typeof e){let n={};return Object.keys(e).forEach((r=>{n[r]=t(e[r])})),n}return e}return parseFloat(e)}const n={baudRate:57600,requestButton:null,requestAccessOnPageLoad:!0,accessText:"To access serial devices, user interaction is required. Please press this button to select the port you want to connect to.",accessButtonLabel:"Connect to Serial Port",styleDomElements:!0,transformer:new class{constructor(){this.chunks=""}transform(e,t){this.chunks+=e;const n=this.chunks.split("\r\n");this.chunks=n.pop(),n.forEach((e=>t.enqueue(e)))}flush(e){e.enqueue(this.chunks)}},logIncomingSerialData:!1,logOutgoingSerialData:!1,parseStringsAsNumbers:!0,warnAboutUnregisteredEvents:!0,newLineCharacter:"\n",filters:[]};const r=function(e){if(!navigator.serial)throw new Error("The Serial API not supported in your browser. Make sure you've enabled flags if necessary!");"number"==typeof e?e={...n,baudRate:e}:void 0===e?e=n:"object"==typeof e&&(e={...n,...e}),null!=e.requestButton&&(e={requestAccessOnPageLoad:!1,...e});let r=e;const o={configuration:r,port:null,writer:null,modal:null,_listeners:{},_this:this,requestSerialAccessOnClick:function(e){if("string"==typeof e){const t=document.getElementById(e);if(!t)throw"Could not find element with ID '"+e+"'.";e=t}e.addEventListener("click",o.connect)},createModal(){o.modal=document.createElement("div"),o.configuration.styleDomElements&&o.modal.setAttribute("style","position: fixed; left: 0; top: 0; width: 100%; height: 100%; left: 0; top: 0; z-index: 10000");const e=document.createElement("div");o.configuration.styleDomElements&&e.setAttribute("style","background-color: rgba(0,0,0,.3); position: absolute; left: 0; top: 0; width: 100%; height: 100%; left: 0; top: 0; cursor: pointer"),e.classList.add("SimpleSerial-modal-overlay");const t=document.createElement("div");o.configuration.styleDomElements&&t.setAttribute("style","position: absolute; width: 100%; height: auto; padding: 4rem; box-sizing: border-box; "),t.classList.add("SimpleSerial-modal-container");const n=document.createElement("div");o.configuration.styleDomElements&&n.setAttribute("style","background-color: #fff; border-radius: 4px; padding: 1rem; box-shadow: 0px 2px 11px 4px rgba(0,0,0, .09);"),n.classList.add("SimpleSerial-modal-inner");const r=document.createElement("p");o.configuration.styleDomElements&&r.setAttribute("style","color: #000"),r.innerText=o.configuration.accessText;const s=document.createElement("button");return s.innerText=o.configuration.accessButtonLabel,o.requestSerialAccessOnClick(s),n.append(r,s),t.append(n),o.modal.append(e,t),document.body.append(o.modal),o.modal},removeModal(){o.modal.remove()},connect:async function(){o.port=await navigator.serial.requestPort({filters:o.configuration.filters}),await o.port.open({baudRate:o.configuration.baudRate}),o.configuration.requestAccessOnPageLoad&&o.removeModal();const e=new TextEncoderStream;e.readable.pipeTo(o.port.writable),o.writer=e.writable.getWriter();let t=new TextDecoderStream;o.port.readable.pipeTo(t.writable);const n=t.readable.pipeThrough(new TransformStream(o.configuration.transformer)).getReader();o.readLoop(n).then((e=>{console.log(e)})).catch((e=>{console.error("Could not read serial data. Please make sure the same baud rate is used on device (Serial.begin()) and library. Library currently uses baud rate",o.configuration.baudRate,"Please also make sure you're not sending too much serial data. Consider using (a higher) delay() to throttle the amount of data sent."),console.error(e)}))},on:(e,t)=>(o._listeners[e]||(o._listeners[e]=[]),o._listeners[e].push(t),[e,t]),removeListener(e,t){if("object"==typeof e&&void 0===t&&(t=e[1],e=e[0]),!o._listeners[e])throw new Error("There is no listener named "+e+".");let n=o._listeners[e].length;return o._listeners[e]=o._listeners[e].filter((e=>e!==t)),n!==o._listeners[e].length},removeListeners(e){if("string"!=typeof e)throw new Error("removeListeners expects a string as parameter, which will be used to remove all listeners of that event.");const t=o._listeners[e].length;return o._listeners[e]=[],t>0},ready:()=>o.port?.readable&&o.port?.writable,writable:()=>o.port?.writable,readable:()=>o.port?.readable,async send(e,n){if(!o.port?.writable)return;if(void 0===n)return o.configuration.logOutgoingSerialData&&console.log(e),o.configuration.parseStringsAsNumbers&&(e=t(e)),o.sendData(e);o.configuration.parseStringsAsNumbers&&(n=t(n));const r=[e,n],s=JSON.stringify(r);return o.configuration.logOutgoingSerialData&&console.log(s),o.writer.write(s+o.configuration.newLineCharacter)},sendEvent:async e=>o.send("_e",e),sendData:async e=>o.send("_d",e),emit(e,t){if(o.configuration.warnAboutUnregisteredEvents&&!o._listeners[e])return console.warn("Event "+e+" has been received, but it has never been registered as listener.");o._listeners[e].forEach((e=>e(t)))},async readLoop(e){for(;;){const{value:t,done:n}=await e.read();if(t){let e=null;try{e=JSON.parse(t)}catch(e){}if(e)if(o.configuration.logIncomingSerialData&&console.log(e),"object"==typeof e){if("_w"===e[0]){console.warn("[ARDUINO] "+e[1]);continue}if("_l"===e[0]){console.log("[ARDUINO] "+e[1]);continue}if("_e"===e[0]){console.error("[ARDUINO] "+e[1]);continue}if("_d"===e[0]){o.emit("data",e[1]);continue}o.emit(e[0],e[1])}else"string"==typeof e&&o.emit(e,null);else o.configuration.logIncomingSerialData&&console.log(t)}if(n){console.log("[readLoop] DONE",n),e.releaseLock();break}}}};return r.requestButton&&o.requestSerialAccessOnClick(r.requestButton),r.requestAccessOnPageLoad&&window.addEventListener("load",o.createModal()),o};e.connect=function(e){return r(e)}}));
//# sourceMappingURL=simple-serial.min.js.map
